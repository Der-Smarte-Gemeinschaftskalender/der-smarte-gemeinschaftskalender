# Upstream definitions
upstream backend
{
	server backend:80;
}

upstream frontend
{
	server frontend:80;
}

upstream mobilizon
{
	server mobilizon:4000;
}

# Additional nginx settings
client_max_body_size 100M;

# Main domain server block
server
{
	listen 80;
	server_name ~^(?!mobilizon\.).*$; # Match all except mobilizon subdomain

	# Security headers
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header Referrer-Policy "no-referrer-when-downgrade" always;

	# Let's Encrypt ACME challenge
	location /.well-known/acme-challenge/
	{
		root /var/www/certbot;
	}

	# ActivityPub webfinger route
	location /.well-known/webfinger
	{
		proxy_pass http://mobilizon;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# ActivityPub user/group profiles (@username routes)
	location ~ ^/@[^/]+/?$
	{
		proxy_pass http://mobilizon;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# API routes to backend (all API routes)
	location /dsgapi/
	{
		proxy_pass http://backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;

		# CORS headers for API
		add_header Access-Control-Allow-Origin $http_origin always;
		add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
		add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;

		if ($request_method = 'OPTIONS')
		{
			add_header Access-Control-Max-Age 1728000;
			add_header Content-Type 'text/plain charset=UTF-8';
			add_header Content-Length 0;
			return 204;
		}
	}

	# Laravel authentication routes
	location ~ ^/(login|register|forgot-password|reset-password|verify-email|confirm-password|logout)$
	{
		proxy_pass http://backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Laravel dashboard and settings
	location ~ ^/(dashboard|settings)/
	{
		proxy_pass http://backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}


	# Block certain sensitive routes
	location ~ ^/(\.env|\.git|storage/logs|config/)
	{
		deny all;
		return 404;
	}

	# Frontend routes - specific Vue.js routes (SPA with hash routing)
	# Public routes that should go to frontend, with ActivityPub filtering for events
	location ~ ^/(search|calendar|organisations|exports|not-found)$
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Event route - ActivityPub requests go to Mobilizon
	location ~ ^/events?$ {
		set $backend "frontend";
		
		if ($http_accept ~ "application/(activity\+json|ld\+json)") {
			set $backend "mobilizon";
		}
		#if ($http_user_agent ~ "Mastodon") {
		#	set $backend "mobilizon";
		#}
		
		proxy_pass http://$backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Frontend routes with parameters - regex patterns (with ActivityPub filtering for events)
	location ~ ^/(organisation/[^/]+|exports/email/confirm/[^/]+/[^/]+|material-generator/(event|organisation)/[^/]+|findEvent/[^/]+)$
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Event detail routes - ActivityPub requests go to Mobilizon
	location ~ ^/events?/[^/]+$ {
		set $backend "frontend";
		
		if ($http_accept ~ "application/(activity\+json|ld\+json)") {
			set $backend "mobilizon";
		}
		#if ($http_user_agent ~ "Mastodon") {
		#	set $backend "mobilizon";
		#}
		
		proxy_pass http://$backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Frontend app routes - authenticated sections
	location ~ ^/app(/.*)?$
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Frontend static assets (JS, CSS, images, fonts)
	location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;

		# Cache static assets
		expires 1y;
		add_header Cache-Control "public, immutable";
	}

	# Frontend root route - ActivityPub requests go to Mobilizon
	location = / {
		set $backend "frontend";
		
		if ($http_accept ~ "application/(activity\+json|ld\+json)") {
			set $backend "mobilizon";
		}
		#if ($http_user_agent ~ "Mastodon") {
		#	set $backend "mobilizon";
		#}
		
		proxy_pass http://$backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Laravel storage/public files
	location /storage/
	{
		proxy_pass http://backend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# Frontend js/css file
	location ~* \.(js|css)$
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;

		# Cache static assets
		expires 1y;
		add_header Cache-Control "public, immutable";
	}

	# Mobilizon API routes (proxied to subdomain for API calls)
	location /api
	{
		proxy_pass http://mobilizon;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;

		# CORS headers for Mobilizon API
		add_header Access-Control-Allow-Origin * always;
		add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
		add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;

		if ($request_method = 'OPTIONS')
		{
			add_header Access-Control-Max-Age 1728000;
			add_header Content-Type 'text/plain charset=UTF-8';
			add_header Content-Length 0;
			return 204;
		}
	}

	# Default fallback for main domain - serve frontend for unmatched routes
	location /
	{
		proxy_pass http://frontend;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;
	}

	# Health check endpoint
	location /health
	{
		access_log off;
		return 200 "healthy\n";
		add_header Content-Type text/plain;
	}
}

# Mobilizon subdomain server block
server
{
	listen 80;
	server_name ~^mobilizon\..*$; # Match events subdomain

	# Security headers
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header Referrer-Policy "no-referrer-when-downgrade" always;

	# Let's Encrypt ACME challenge
	location /.well-known/acme-challenge/
	{
		root /var/www/certbot;
	}

	# All routes go to Mobilizon for events subdomain
	location /
	{
		proxy_pass http://mobilizon;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_redirect off;

		# WebSocket support for Mobilizon
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_read_timeout 86400;

		# CORS headers for Mobilizon
		add_header Access-Control-Allow-Origin * always;
		add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
		add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;

		if ($request_method = 'OPTIONS')
		{
			add_header Access-Control-Max-Age 1728000;
			add_header Content-Type 'text/plain charset=UTF-8';
			add_header Content-Length 0;
			return 204;
		}
	}

	# Health check endpoint for subdomain
	location /health
	{
		access_log off;
		return 200 "healthy\n";
		add_header Content-Type text/plain;
	}
}